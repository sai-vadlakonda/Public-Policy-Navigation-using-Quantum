<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Added for responsive design -->
    <title>PolicyNav Public Policy Navigation Using AI</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f0f7, #dbe7f2);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }
        h1 {
            margin-top: 40px;
            color: #2c3e50;
            text-align: center;
            font-weight: 700;
        }
        form {
            margin: 25px 0;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        input[type="text"] {
            width: 400px;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            transition: 0.3s;
        }
        input[type="text"]:focus {
            border-color: #2980b9;
            outline: none;
            box-shadow: 0 0 8px rgba(41, 128, 185, 0.3);
        }
        button {
            padding: 12px 25px;
            font-size: 16px;
            background: linear-gradient(135deg, #2980b9, #3498db);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        button:hover {
            background: linear-gradient(135deg, #2471a3, #1f618d);
        }
        .results-container {
            width: 85%;
            max-width: 1000px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .result-card {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0px 8px 25px rgba(0,0,0,0.08);
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0px 12px 25px rgba(0,0,0,0.15);
        }
        .result-card h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 18px;
        }
        .meta {
            font-size: 13px;
            color: #888;
            margin-bottom: 10px;
        }
        .score {
            font-weight: 600;
            color: #27ae60;
        }
        .charts-container {
            width: 85%;
            max-width: 1000px;
            display: flex;
            flex-direction: row; /* Explicitly set to row for side-by-side */
            justify-content: space-between;
            align-items: flex-start; /* Align tops of charts */
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: nowrap; /* Prevent wrapping unless on small screens */
        }
        .chart-box {
            flex: 1; /* Equal width for both charts */
            min-width: 300px; /* Minimum width to prevent shrinking */
            max-width: 450px;
            background: #fff;
            padding: 25px;
            border-radius: 14px;
            box-shadow: 0px 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .chart-box h3 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }
        @media (max-width: 768px) {
            input[type="text"] { width: 90%; }
            .charts-container {
                flex-direction: column; /* Stack charts vertically on small screens */
                align-items: center;
            }
            .chart-box { 
                width: 90%; 
                max-width: 350px; 
            }
        }
        .error-message {
            color: #e74c3c;
            font-size: 16px;
            text-align: center;
            margin: 20px;
        }
    </style>
    <!-- Load Chart.js and DataLabels plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
    <h1><i class="fas fa-atom"></i> Quantum Education Policy Navigation Using AI</h1>

    <form method="post" action="/search">
        <input type="text" name="query" placeholder="Enter your query..." required>
        <button type="submit">Search</button>
    </form>

    {% if error %}
    <div class="error-message">{{ error }}</div>
    {% endif %}

    {% if results %}
    <div class="results-container">
        {% for r in results %}
        <div class="result-card">
            <h3>{{ r.title|default("Unknown Title") }} ({{ r.policy_id|default("N/A") }})</h3>
            <div class="meta">Region: {{ r.region|default("Unknown") }} | Year: {{ r.year|default("Unknown") }} | Status: {{ r.status|default("Unknown") }}</div>
            <div class="meta">Relevance Score: <span class="score">{{ r.score|default(0.0)|round(3) }}</span></div>
            <p>{{ r.summary|default("No summary available") }}</p>
        </div>
        {% endfor %}
    </div>

    <!-- Charts container for side-by-side pie and bar charts -->
    <div class="charts-container">
        <!-- Pie Chart: Region Distribution -->
        <div class="chart-box">
            <h3>ðŸ“Š Policy Distribution by Region</h3>
            <canvas id="regionPieChart" width="300" height="300"></canvas>
        </div>
        <!-- Bar Chart: Status Distribution -->
        <div class="chart-box">
            <h3>ðŸ“Š Policy Distribution by Status</h3>
            <canvas id="statusBarChart" width="300" height="300"></canvas>
        </div>
    </div>

    <!-- Chart.js Script for Pie and Bar Charts -->
    <script>
        // Pie Chart: Region Distribution
        const regions = [{% for r in results %}"{{ r.region|default('Unknown') }}",{% endfor %}];
        const regionCounts = {};
        regions.forEach(r => {
            regionCounts[r] = (regionCounts[r] || 0) + 1;
        });
        const totalRegions = regions.length;
        const colors = [
            '#3498db', '#e74c3c', '#2ecc71', '#f1c40f',
            '#9b59b6', '#16a085', '#e67e22', '#1abc9c'
        ];
        const regionCtx = document.getElementById('regionPieChart').getContext('2d');
        new Chart(regionCtx, {
            type: 'pie',
            data: {
                labels: Object.keys(regionCounts),
                datasets: [{
                    data: Object.values(regionCounts),
                    backgroundColor: colors.slice(0, Object.keys(regionCounts).length),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: false,
                animation: {
                    animateScale: true,
                    animateRotate: true
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#2c3e50', font: { size: 13 } }
                    },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 12 },
                        formatter: (value, context) => {
                            const percentage = ((value / totalRegions) * 100).toFixed(1);
                            const label = context.chart.data.labels[context.dataIndex];
                            return `${label}\n${percentage}%`;
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.chart._metasets[context.datasetIndex].total;
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${percentage}%`;
                            }
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        // Bar Chart: Status Distribution
        const statuses = [{% for r in results %}"{{ r.status|default('Unknown') }}",{% endfor %}];
        const statusCounts = {};
        statuses.forEach(s => {
            statusCounts[s] = (statusCounts[s] || 0) + 1;
        });
        const statusCtx = document.getElementById('statusBarChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    label: 'Number of Policies',
                    data: Object.values(statusCounts),
                    backgroundColor: colors.slice(0, Object.keys(statusCounts).length),
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Number of Policies', color: '#2c3e50' },
                        ticks: { color: '#2c3e50', stepSize: 1 }
                    },
                    x: {
                        title: { display: true, text: 'Status', color: '#2c3e50' },
                        ticks: { color: '#2c3e50' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        color: '#2c3e50',
                        font: { weight: 'bold', size: 12 },
                        anchor: 'end',
                        align: 'top',
                        formatter: (value) => value
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    </script>
    {% endif %}
</body>
</html>